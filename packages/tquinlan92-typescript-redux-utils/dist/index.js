"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var lodash_1 = require("lodash");
var typescript_fsa_1 = require("typescript-fsa");
function createReducer(initialState, actions) {
    return function (state, incomingAction) {
        if (state === void 0) { state = initialState; }
        var actionMatch = lodash_1.find(actions, function (action) {
            return typescript_fsa_1.isType(incomingAction, action.actionCreator);
        });
        if (actionMatch) {
            return actionMatch.reducer(state, incomingAction.payload);
        }
        else {
            return state;
        }
    };
}
exports.createReducer = createReducer;
function makeActionCreatorWithReducer(name, reducer) {
    var SimpleActionCreator = typescript_fsa_1.default();
    return {
        actionCreator: SimpleActionCreator(name),
        reducer: reducer
    };
}
exports.makeActionCreatorWithReducer = makeActionCreatorWithReducer;
function getCreators(creators) {
    return lodash_1.mapValues(creators, "actionCreator");
}
exports.getCreators = getCreators;
function makeActionCreatorWithReducerWithPrefix(actionName, reducer) {
    return function (reducerName) { return makeActionCreatorWithReducer(JSON.stringify({ reducerName: reducerName, actionName: actionName }), reducer); };
}
exports.makeActionCreatorWithReducerWithPrefix = makeActionCreatorWithReducerWithPrefix;
function getReducersFromCombinedActionReducer(creators) {
    return lodash_1.mapValues(creators, "reducer");
}
exports.getReducersFromCombinedActionReducer = getReducersFromCombinedActionReducer;
function getActionsFromCombinedActionReducer(creators) {
    return lodash_1.mapValues(creators, "actions");
}
exports.getActionsFromCombinedActionReducer = getActionsFromCombinedActionReducer;
function getActionsAndReducersFromCombinedActionReducer(creators) {
    return {
        actions: getActionsFromCombinedActionReducer(creators),
        reducers: getReducersFromCombinedActionReducer(creators)
    };
}
exports.getActionsAndReducersFromCombinedActionReducer = getActionsAndReducersFromCombinedActionReducer;
function testRunner(reducer) {
    return function (initalState, action) {
        return reducer(initalState, action);
    };
}
exports.testRunner = testRunner;
function makeSimpleReducer(reducerName, initialState) {
    var actions = lodash_1.mapValues(initialState, function (propertyFromState, key) {
        var creatorReducer = makeActionCreatorWithReducerWithPrefix("UPDATE_" + key.toUpperCase(), function (state, newValue) {
            var _a;
            return lodash_1.assign({}, state, (_a = {}, _a[key] = newValue, _a));
        });
        return creatorReducer(reducerName);
    });
    var reset = makeActionCreatorWithReducerWithPrefix("RESET", function () {
        return initialState;
    })(reducerName);
    var setAll = makeActionCreatorWithReducerWithPrefix("SET_ALL", function (state, newValue) {
        return newValue;
    })(reducerName);
    var set = makeActionCreatorWithReducerWithPrefix("SET", function (state, newStateValues) {
        return lodash_1.assign({}, state, newStateValues);
    })(reducerName);
    return {
        actions: lodash_1.assign({}, getCreators(lodash_1.assign({}, actions, { reset: reset, setAll: setAll, set: set }))),
        reducer: createReducer(initialState, lodash_1.assign({}, actions, { reset: reset, setAll: setAll, set: set })),
    };
}
exports.makeSimpleReducer = makeSimpleReducer;
function getActions(creators) {
    return lodash_1.mapValues(creators, "actions");
}
exports.getActions = getActions;
function makeNestedSimpleReducerSimpleActions(state) {
    var actionsReducers = lodash_1.mapValues(state, function (value, key) {
        return makeSimpleReducer(key, lodash_1.omit(value, 'actions'));
    });
    var reducers = lodash_1.mapValues(actionsReducers, 'reducer');
    var actions = getActions(actionsReducers);
    return {
        actions: actions,
        reducers: reducers
    };
}
exports.makeNestedSimpleReducerSimpleActions = makeNestedSimpleReducerSimpleActions;
function makeNestedSimpleStore(state, thunkActions) {
    var _a = makeNestedSimpleReducerSimpleActions(state), actions1 = _a.actions, reducers2 = _a.reducers;
    var actionsWithThunks = lodash_1.merge(actions1, thunkActions);
    return {
        actions: actionsWithThunks,
        reducers: reducers2
    };
}
exports.makeNestedSimpleStore = makeNestedSimpleStore;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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RSxTQUFTLENBQUMsQ0FBQyxDQUFDO0lBQzFELENBQUMsQ0FBQyxDQUFDO0lBQ0gsSUFBTSxRQUFRLEdBQUcsa0JBQVMsQ0FBQyxlQUFlLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDdkQsSUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBRTVDLE9BQU87UUFDSCxPQUFPLFNBQUE7UUFDUCxRQUFRLFVBQUE7S0FnQlgsQ0FBQztBQUNOLENBQUM7QUExQkQsb0ZBMEJDO0FBRUQsU0FBZ0IscUJBQXFCLENBQXNCLEtBQVksRUFBRSxZQUEyQjtJQUMxRixJQUFBLGdEQUErRixFQUE3RixxQkFBaUIsRUFBRSx1QkFBMEUsQ0FBQztJQUN0RyxJQUFNLGlCQUFpQixHQUFHLGNBQUssQ0FBQyxRQUFRLEVBQUUsWUFBWSxDQUFDLENBQUM7SUFDeEQsT0FBTztRQUNILE9BQU8sRUFBRSxpQkFBaUI7UUFDMUIsUUFBUSxFQUFFLFNBQVM7S0FDdEIsQ0FBQztBQUNOLENBQUM7QUFQRCxzREFPQyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZpbmQsIG1hcFZhbHVlcywgYXNzaWduLCBEaWN0aW9uYXJ5LCBtZXJnZSwgb21pdCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgYWN0aW9uQ3JlYXRvckZhY3RvcnksIHsgaXNUeXBlLCBBY3Rpb24sIEFueUFjdGlvbiwgQWN0aW9uQ3JlYXRvciB9IGZyb20gXCJ0eXBlc2NyaXB0LWZzYVwiO1xuaW1wb3J0IHsgUmVkdWNlciB9IGZyb20gJ3JlZHV4JztcblxuZXhwb3J0IHsgQWN0aW9uLCBBbnlBY3Rpb24sIEFjdGlvbkNyZWF0b3IgfTtcblxuZXhwb3J0IGludGVyZmFjZSBBY3Rpb25DcmVhdG9yV2l0aFJlZHVjZXI8U3RhdGVUeXBlPiB7XG4gICAgYWN0aW9uQ3JlYXRvcjogQWN0aW9uQ3JlYXRvcjxhbnk+O1xuICAgIHJlZHVjZXI6IChzdGF0ZTogU3RhdGVUeXBlLCBhY3Rpb246IGFueSkgPT4gU3RhdGVUeXBlO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFjdGlvbkNyZWF0b3JXaXRoUmVkdWNlckdyb3VwPFN0YXRlVHlwZT4ge1xuICAgIFtrZXk6IHN0cmluZ106IEFjdGlvbkNyZWF0b3JXaXRoUmVkdWNlcjxTdGF0ZVR5cGU+O1xufVxuIFxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVJlZHVjZXI8U3RhdGVUeXBlPihpbml0aWFsU3RhdGU6IFN0YXRlVHlwZSwgYWN0aW9uczogQWN0aW9uQ3JlYXRvcldpdGhSZWR1Y2VyR3JvdXA8U3RhdGVUeXBlPikge1xuICAgIHJldHVybiAoc3RhdGU6IFN0YXRlVHlwZSA9IGluaXRpYWxTdGF0ZSwgaW5jb21pbmdBY3Rpb246IEFjdGlvbjxBbnlBY3Rpb24+KTogU3RhdGVUeXBlID0+IHtcbiAgICAgICAgY29uc3QgYWN0aW9uTWF0Y2ggPSBmaW5kKGFjdGlvbnMsIGFjdGlvbiA9PiB7XG4gICAgICAgICAgICByZXR1cm4gaXNUeXBlKGluY29taW5nQWN0aW9uLCBhY3Rpb24uYWN0aW9uQ3JlYXRvcik7XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoYWN0aW9uTWF0Y2gpIHtcbiAgICAgICAgICAgIHJldHVybiBhY3Rpb25NYXRjaC5yZWR1Y2VyKHN0YXRlLCBpbmNvbWluZ0FjdGlvbi5wYXlsb2FkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBzdGF0ZTtcbiAgICAgICAgfVxuICAgIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3RhdGVUeXBlUmVkdWNlcjxTdGF0ZVR5cGUsIEFjdGlvblBhcmFtcz4ge1xuICAgIChzdGF0ZTogU3RhdGVUeXBlLCBhY3Rpb246IEFjdGlvblBhcmFtcyk6IFN0YXRlVHlwZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VBY3Rpb25DcmVhdG9yV2l0aFJlZHVjZXI8U3RhdGVUeXBlLCBBY3Rpb25QYXJhbXM+KG5hbWU6IHN0cmluZywgcmVkdWNlcjogU3RhdGVUeXBlUmVkdWNlcjxTdGF0ZVR5cGUsIEFjdGlvblBhcmFtcz4pIHtcbiAgICBjb25zdCBTaW1wbGVBY3Rpb25DcmVhdG9yID0gYWN0aW9uQ3JlYXRvckZhY3RvcnkoKTtcbiAgICByZXR1cm4ge1xuICAgICAgICBhY3Rpb25DcmVhdG9yOiBTaW1wbGVBY3Rpb25DcmVhdG9yPEFjdGlvblBhcmFtcz4obmFtZSksXG4gICAgICAgIHJlZHVjZXJcbiAgICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q3JlYXRvcnM8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogQWN0aW9uQ3JlYXRvcldpdGhSZWR1Y2VyPGFueT4gfT4oY3JlYXRvcnM6IFQpOiB7IFtQIGluIGtleW9mIFRdOiBUW1BdWydhY3Rpb25DcmVhdG9yJ10gfSB7XG4gICAgcmV0dXJuIG1hcFZhbHVlcyhjcmVhdG9ycywgXCJhY3Rpb25DcmVhdG9yXCIpIGFzIHsgW1AgaW4ga2V5b2YgVF06IFRbUF1bJ2FjdGlvbkNyZWF0b3InXSB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWFrZUFjdGlvbkNyZWF0b3JXaXRoUmVkdWNlcldpdGhQcmVmaXg8U3RhdGVUeXBlLCBBY3Rpb25QYXJhbXM+KGFjdGlvbk5hbWU6IHN0cmluZywgcmVkdWNlcjogU3RhdGVUeXBlUmVkdWNlcjxTdGF0ZVR5cGUsIEFjdGlvblBhcmFtcz4pIHtcbiAgICByZXR1cm4gKHJlZHVjZXJOYW1lPzogc3RyaW5nKSA9PiBtYWtlQWN0aW9uQ3JlYXRvcldpdGhSZWR1Y2VyPFN0YXRlVHlwZSwgQWN0aW9uUGFyYW1zPihKU09OLnN0cmluZ2lmeSh7IHJlZHVjZXJOYW1lLCBhY3Rpb25OYW1lIH0pLCByZWR1Y2VyKTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTaW1wbGVBbmRUaHVua0FjdGlvbnMge1xuICAgIFtrZXk6IHN0cmluZ106IGFueTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBY3Rpb25zQW5kUmVkdWNlciB7XG4gICAgYWN0aW9ucz86IFNpbXBsZUFuZFRodW5rQWN0aW9ucztcbiAgICByZWR1Y2VyPzogUmVkdWNlcjxhbnksIEFueUFjdGlvbj47XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRSZWR1Y2Vyc0Zyb21Db21iaW5lZEFjdGlvblJlZHVjZXI8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogQWN0aW9uc0FuZFJlZHVjZXIgfT4oY3JlYXRvcnM6IFQpOiB7IFtQIGluIGtleW9mIFRdOiBUW1BdWydyZWR1Y2VyJ10gfSB7XG4gICAgcmV0dXJuIG1hcFZhbHVlcyhjcmVhdG9ycywgXCJyZWR1Y2VyXCIpIGFzIHsgW1AgaW4ga2V5b2YgVF06IFRbUF1bJ3JlZHVjZXInXSB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0QWN0aW9uc0Zyb21Db21iaW5lZEFjdGlvblJlZHVjZXI8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogQWN0aW9uc0FuZFJlZHVjZXIgfT4oY3JlYXRvcnM6IFQpOiB7IFtQIGluIGtleW9mIFRdOiBUW1BdWydhY3Rpb25zJ10gfSB7XG4gICAgcmV0dXJuIG1hcFZhbHVlcyhjcmVhdG9ycywgXCJhY3Rpb25zXCIpIGFzIHsgW1AgaW4ga2V5b2YgVF06IFRbUF1bJ2FjdGlvbnMnXSB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFjdGlvbnNBbmRSZWR1Y2VyU2V0dXAge1xuICAgIFtrZXk6IHN0cmluZ106IEFjdGlvbnNBbmRSZWR1Y2VyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFjdGlvbnNSZWR1Y2Vyc0Zyb21Db21iaW5lZEFjdGlvblJlZHVjZXI8QWN0aW9uc1JlZHVjZXJzSW5zdGFuY2VzIGV4dGVuZHMgQWN0aW9uc0FuZFJlZHVjZXJTZXR1cD4ge1xuICAgIGFjdGlvbnM6IHsgW1AgaW4ga2V5b2YgQWN0aW9uc1JlZHVjZXJzSW5zdGFuY2VzXTogQWN0aW9uc1JlZHVjZXJzSW5zdGFuY2VzW1BdWydhY3Rpb25zJ10gfTtcbiAgICByZWR1Y2VyczogeyBbUCBpbiBrZXlvZiBBY3Rpb25zUmVkdWNlcnNJbnN0YW5jZXNdOiBBY3Rpb25zUmVkdWNlcnNJbnN0YW5jZXNbUF1bJ3JlZHVjZXInXSB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0QWN0aW9uc0FuZFJlZHVjZXJzRnJvbUNvbWJpbmVkQWN0aW9uUmVkdWNlcjxDcmVhdG9ycyBleHRlbmRzIEFjdGlvbnNBbmRSZWR1Y2VyU2V0dXA+KGNyZWF0b3JzOiBDcmVhdG9ycyk6IEFjdGlvbnNSZWR1Y2Vyc0Zyb21Db21iaW5lZEFjdGlvblJlZHVjZXI8Q3JlYXRvcnM+IHtcbiAgICByZXR1cm4ge1xuICAgICAgICBhY3Rpb25zOiBnZXRBY3Rpb25zRnJvbUNvbWJpbmVkQWN0aW9uUmVkdWNlcihjcmVhdG9ycykgYXMgeyBbUCBpbiBrZXlvZiBDcmVhdG9yc106IENyZWF0b3JzW1BdWydhY3Rpb25zJ10gfSxcbiAgICAgICAgcmVkdWNlcnM6IGdldFJlZHVjZXJzRnJvbUNvbWJpbmVkQWN0aW9uUmVkdWNlcihjcmVhdG9ycykgYXMgeyBbUCBpbiBrZXlvZiBDcmVhdG9yc106IENyZWF0b3JzW1BdWydyZWR1Y2VyJ10gfVxuICAgIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0ZXN0UnVubmVyPFJlZHVjZXJTdGF0ZT4ocmVkdWNlcjogUmVkdWNlcikge1xuICAgIHJldHVybiAoaW5pdGFsU3RhdGU6IFJlZHVjZXJTdGF0ZSwgYWN0aW9uOiBBbnlBY3Rpb24pID0+IHtcbiAgICAgICAgcmV0dXJuIHJlZHVjZXIoaW5pdGFsU3RhdGUsIGFjdGlvbik7XG4gICAgfTtcbn1cblxudHlwZSBQYXJ0aWFsPFQ+ID0ge1xuICAgIFtQIGluIGtleW9mIFRdPzogVFtQXTtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBtYWtlU2ltcGxlUmVkdWNlcjxTdGF0ZSBleHRlbmRzIHt9PihyZWR1Y2VyTmFtZTogc3RyaW5nLCBpbml0aWFsU3RhdGU6IFN0YXRlKSB7XG4gICAgY29uc3QgYWN0aW9ucyA9IG1hcFZhbHVlcyhpbml0aWFsU3RhdGUsIChwcm9wZXJ0eUZyb21TdGF0ZSwga2V5OiBrZXlvZiBTdGF0ZSkgPT4ge1xuICAgICAgICBjb25zdCBjcmVhdG9yUmVkdWNlciA9IG1ha2VBY3Rpb25DcmVhdG9yV2l0aFJlZHVjZXJXaXRoUHJlZml4PFN0YXRlLCBTdGF0ZVt0eXBlb2Yga2V5XT4oXG4gICAgICAgICAgICBgVVBEQVRFXyR7a2V5LnRvVXBwZXJDYXNlKCl9YCxcbiAgICAgICAgICAgIChzdGF0ZSwgbmV3VmFsdWUpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYXNzaWduKHt9LCBzdGF0ZSxcbiAgICAgICAgICAgICAgICAgICAge1trZXldOiBuZXdWYWx1ZX1cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gY3JlYXRvclJlZHVjZXIocmVkdWNlck5hbWUpIGFzIGFueTtcbiAgICB9KSBhcyB7XG4gICAgICAgIFtQIGluIGtleW9mIFN0YXRlXToge1xuICAgICAgICAgICAgYWN0aW9uQ3JlYXRvcjogQWN0aW9uQ3JlYXRvcjxTdGF0ZVtQXT47XG4gICAgICAgICAgICByZWR1Y2VyOiBTdGF0ZVR5cGVSZWR1Y2VyPFN0YXRlLCBTdGF0ZVtQXT47XG4gICAgICAgIH1cbiAgICB9O1xuICAgIGNvbnN0IHJlc2V0ID0gbWFrZUFjdGlvbkNyZWF0b3JXaXRoUmVkdWNlcldpdGhQcmVmaXg8U3RhdGUsIG51bGw+KFxuICAgICAgICBgUkVTRVRgLFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gaW5pdGlhbFN0YXRlO1xuICAgICAgICB9XG4gICAgKShyZWR1Y2VyTmFtZSk7XG4gICAgY29uc3Qgc2V0QWxsID0gbWFrZUFjdGlvbkNyZWF0b3JXaXRoUmVkdWNlcldpdGhQcmVmaXg8U3RhdGUsIFN0YXRlPihcbiAgICAgICAgYFNFVF9BTExgLFxuICAgICAgICAoc3RhdGUsIG5ld1ZhbHVlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gbmV3VmFsdWU7XG4gICAgICAgIH1cbiAgICApKHJlZHVjZXJOYW1lKTtcbiAgICBjb25zdCBzZXQgPSBtYWtlQWN0aW9uQ3JlYXRvcldpdGhSZWR1Y2VyV2l0aFByZWZpeDxTdGF0ZSwgUGFydGlhbDxTdGF0ZT4+KFxuICAgICAgICBgU0VUYCxcbiAgICAgICAgKHN0YXRlLCBuZXdTdGF0ZVZhbHVlcykgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGFzc2lnbih7fSwgXG4gICAgICAgICAgICAgICAgc3RhdGUsXG4gICAgICAgICAgICAgICAgbmV3U3RhdGVWYWx1ZXNcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICApKHJlZHVjZXJOYW1lKTtcbiAgICByZXR1cm4ge1xuICAgICAgICBhY3Rpb25zOiBhc3NpZ24oe30sIFxuICAgICAgICAgICAgZ2V0Q3JlYXRvcnMoYXNzaWduKHt9LCBhY3Rpb25zLCB7cmVzZXQsIHNldEFsbCwgc2V0fSkpLFxuICAgICAgICApLFxuICAgICAgICByZWR1Y2VyOiBjcmVhdGVSZWR1Y2VyPFN0YXRlPihpbml0aWFsU3RhdGUsIGFzc2lnbih7fSwgYWN0aW9ucywge3Jlc2V0LCBzZXRBbGwsIHNldH0pKSxcbiAgICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0QWN0aW9uczxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiB7YWN0aW9ucz86IERpY3Rpb25hcnk8YW55Pn0gfT4oY3JlYXRvcnM6IFQpOiB7IFtQIGluIGtleW9mIFRdOiBUW1BdWydhY3Rpb25zJ10gfSB7XG4gICAgcmV0dXJuIG1hcFZhbHVlcyhjcmVhdG9ycywgXCJhY3Rpb25zXCIpIGFzIHsgW1AgaW4ga2V5b2YgVF06IFRbUF1bJ2FjdGlvbnMnXSB9O1xufSBcblxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VOZXN0ZWRTaW1wbGVSZWR1Y2VyU2ltcGxlQWN0aW9uczxBcHBTdGF0ZT4oc3RhdGU6IGFueSkge1xuICAgIGNvbnN0IGFjdGlvbnNSZWR1Y2VycyA9IG1hcFZhbHVlcyhzdGF0ZSwgKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgcmV0dXJuIG1ha2VTaW1wbGVSZWR1Y2VyKGtleSwgb21pdCh2YWx1ZSwgJ2FjdGlvbnMnKSk7XG4gICAgfSk7Ly97IFtQIGluIGtleW9mIFRdOiBUW1BdWydhY3Rpb25DcmVhdG9yJ10gXG4gICAgY29uc3QgcmVkdWNlcnMgPSBtYXBWYWx1ZXMoYWN0aW9uc1JlZHVjZXJzLCAncmVkdWNlcicpO1xuICAgIGNvbnN0IGFjdGlvbnMgPSBnZXRBY3Rpb25zKGFjdGlvbnNSZWR1Y2Vycyk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBhY3Rpb25zLFxuICAgICAgICByZWR1Y2Vyc1xuICAgIH0gYXMge1xuICAgICAgICByZWR1Y2Vyczoge1xuICAgICAgICAgICAgW1AgaW4ga2V5b2YgQXBwU3RhdGVdOiBSZWR1Y2VyPEFwcFN0YXRlW1BdLCBBbnlBY3Rpb24+XG4gICAgICAgIH07XG4gICAgICAgIGFjdGlvbnM6IHtcbiAgICAgICAgICAgIFtQIGluIGtleW9mIEFwcFN0YXRlXToge1xuICAgICAgICAgICAgICAgIFtBIGluIGtleW9mIEFwcFN0YXRlW1BdXTogQWN0aW9uQ3JlYXRvcjxBcHBTdGF0ZVtQXVtBXT5cbiAgICAgICAgICAgIH0gJiB7XG4gICAgICAgICAgICAgICAgcmVzZXQ6IEFjdGlvbkNyZWF0b3I8bnVsbD47XG4gICAgICAgICAgICAgICAgc2V0QWxsOiBBY3Rpb25DcmVhdG9yPEFwcFN0YXRlW1BdPjtcbiAgICAgICAgICAgICAgICBzZXQ6IEFjdGlvbkNyZWF0b3I8UGFydGlhbDxBcHBTdGF0ZVtQXT4+O1xuICAgICAgICAgICAgfSAmIHtcbiAgICAgICAgICAgICAgICBbQSBpbiBrZXlvZiBBcHBTdGF0ZVtQXV06IEFwcFN0YXRlW1BdW0FdXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VOZXN0ZWRTaW1wbGVTdG9yZTxTdGF0ZSwgVGh1bmtBY3Rpb25zPihzdGF0ZTogU3RhdGUsIHRodW5rQWN0aW9ucz86IFRodW5rQWN0aW9ucykge1xuICAgIGNvbnN0IHsgYWN0aW9uczogYWN0aW9uczEsIHJlZHVjZXJzOiByZWR1Y2VyczIgfSA9IG1ha2VOZXN0ZWRTaW1wbGVSZWR1Y2VyU2ltcGxlQWN0aW9uczxTdGF0ZT4oc3RhdGUpO1xuICAgIGNvbnN0IGFjdGlvbnNXaXRoVGh1bmtzID0gbWVyZ2UoYWN0aW9uczEsIHRodW5rQWN0aW9ucyk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgYWN0aW9uczogYWN0aW9uc1dpdGhUaHVua3MsXG4gICAgICAgIHJlZHVjZXJzOiByZWR1Y2VyczJcbiAgICB9O1xufVxuIl19
